---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
  word_document: default
---

## Математическое моделирование

### Практика 4

### Линейные регрессионные модели   

В практических примерах ниже показано:   

* как оценить параметры модели линейной регрессии   
* как строить модель со взаимосдействием переменных   
* как визуализировать и тестировать остатки модели линейной регрессии    

*Модели*: множественная линейная регрессия, kNN.   
*Данные*: статистика по зарплатам в г.Москва за 2012 г., российский мониторинг экономического положения и здоровья населения НИУ-ВШЭ [http://www.hse.ru/rlms](http://www.hse.ru/rlms).   

Цель: исследовать набор данных `wages.ru` с помощью линейной регрессионной модели. Задействовав все возможные регрессоры, сделать вывод о пригодности модели для прогноза. Сравнить с методом k ближайших соседей по MSE на тестовой выборке.    

```{r Данные и пакеты, warning = F, message = F}
# загрузка пакетов
library('GGally')       # графики совместного разброса переменных
library('lmtest')       # тесты остатков регрессионных моделей
library('FNN')          # алгоритм kNN

# константы
my.seed <- 12345
train.percent <- 0.85

# загрузка данных
fileURL <- 'https://sites.google.com/a/kiber-guu.ru/msep/mag-econ/salary_data.csv?attredirects=0&d=1'

# преобразуем категориальные переменные в факторы
wages.ru <- read.csv(fileURL, row.names = 1, sep = ';', as.is = T)
wages.ru$male <- as.factor(wages.ru$male)
wages.ru$educ <- as.factor(wages.ru$educ)
wages.ru$forlang <- as.factor(wages.ru$forlang)

# обучающая выборка
set.seed(my.seed)
inTrain <- sample(seq_along(wages.ru$salary), 
                  nrow(wages.ru) * train.percent)
df.train <- wages.ru[inTrain, c(colnames(wages.ru)[-1], colnames(wages.ru)[1])]
df.test <- wages.ru[-inTrain, -1]

```

## Описание переменных  

Набор данных `wages` содержит переменные:  

- `salary` – среднемесячная зарплата после вычета налогов за последние 12 месяцев (рублей);  
- `male` – пол: **1** -- мужчина, **0** -- женщина;
- `educ` – уровень образования:  
**1** – 0-6 классов,  
**2** – незаконченное среднее (7-8 классов),  
**3** - незаконченное среднее плюс что-то ещё,  
**4** – законченное среднее,  
**5** – законченное среднее специальное, 
**6** – законченное высшее образование и выше;  
- `forlang` - иност. язык: **1** -- владеет, **0** – нет;
- `exper` – официальный стаж c 1.01.2002 (лет).

Размерность обучающей выборки: $n = `r dim(df.train)[1]`$ строк, $p = `r dim(df.train)[2] - 1`$ объясняющих переменных. Зависимая переменная -- `salary`.  

```{r Описание данных-01, message = F, warning = F}
# описательные статистики по переменным
summary(df.train)

# совместный график разброса переменных
ggp <- ggpairs(df.train)
print(ggp, progress = F)

# цвета по фактору male
ggp <- ggpairs(df.train[, c('exper', 'male', 'salary')], 
               mapping = ggplot2::aes(color = male))
print(ggp, progress = F)
```

Судя по коробчатой диаграмме на пересечении `sale` и `male`, средний уровень зарплат у мужчин и женщин отличается: мужчины в среднем получают больше. Центральный график показывает, что доли наблюдений с различными значениями признака `male` в наборе данных примерно равны (мужчин чуть больше).     

```{r Описание данных-02, message = F, warning = F}
# цвета по фактору educ
ggp <- ggpairs(df.train[, c('exper', 'educ', 'salary')], 
               mapping = ggplot2::aes(color = educ))
print(ggp, progress = F)
```

Коробчатые диаграммы на пересечении `salary` и `educ` показывают, что самому низкому уровню образования соответствует самая низкая средняя зарплата, и дисперсия зарплат здесь тоже наименьшая. У респондентов с самым высоким уровнем образования дисперсия зарплаты наибольшая. Судя по графику в центре, наблюдения распределены по значениям переменой `educ` неравномерно: группа с самым высоким уровнем образования самая многочисленная.    

```{r Описание данных-03, message = F, warning = F}
# цвета по фактору forlang
ggp <- ggpairs(df.train[, c('exper', 'forlang', 'salary')], 
               mapping = ggplot2::aes(color = forlang))
print(ggp, progress = F)

```

Судя по графику, у сотрудников со знанием иностранного языка (`forlang = 1`) в среднем зарплата выше. Доли наблюдений с `forlang = 1` и `forlang = 0` сопоставимы.   

## Модели  

```{r , warning = F, error = F}

model.1 <- lm(salary ~ . + exper:educ + exper:forlang + exper:male,
              data = df.train)
summary(model.1)

```

Совместное влияние `exper:educ` исключаем, т.к. параметры незначимы и недостаточно наблюдений для оценки одного из них.

```{r , warning = F, error = F}

model.2 <- lm(salary ~ . + exper:forlang + exper:male,
              data = df.train)
summary(model.2)

```

Взаимодействие `male1:exper` также исключаем.

```{r , warning = F, error = F}

model.3 <- lm(salary ~ . + exper:forlang,
              data = df.train)
summary(model.3)

```

Коэффициент при `forlang1` наименее значимый, и его знак не соответствует здравому смыслу.

```{r , warning = F, error = F}

model.4 <- lm(salary ~ male + educ + exper,
              data = df.train)
summary(model.4)

```

В модели практичски нет значимых объясняющих переменных. Вероятно, это из-за того, что подвыборки по уровням фактора `educ` очень маленькие. Попробуем сделать `educ` дискретной количественной переменной.

```{r , warning = F, error = F}
df.train$educ <- as.numeric(df.train$educ)
df.test$educ <- as.numeric(df.test$educ)

model.6 <- lm(salary ~ .,
              data = df.train)
summary(model.6)

```

Эта модель лучше, но по характеристикам качества очень слабая. Пробуем добавить взаимодействие `exper:male`.  

```{r , warning = F, error = F}
df.train$educ <- as.numeric(df.train$educ)

model.7 <- lm(salary ~ . + exper:male,
              data = df.train)
summary(model.7)

```

Очевидно, стоит остановиться на модели без взаимодействий. Проверим её остатки. 

# Проверка остатков  

```{r , warning = F, error = F}
# тест Бройша-Пагана
bptest(model.6)

# статистика Дарбина-Уотсона
dwtest(model.6)

# графики остатков
par(mar = c(4.5, 4.5, 2, 1))
par(mfrow = c(1, 3))
plot(model.7, 1)
plot(model.7, 4)
plot(model.7, 5)
par(mfrow = c(1, 1))

```

Судя по графику слева, остатки не случайны, и их дисперсия непостоянна. В модели есть три влиятельных наблюдения: 104, 105, 114, -- которые, однако, не выходят за пределы доверительных границ на третьем графике. Графики остатков заставляют усомниться в том, что остатки удовлетворяют условиям Гаусса-Маркова.      

# Сравнение с kNN

```{r }
# фактические значения y на тестовой выборке
y.fact <- wages.ru[-inTrain, 1]
y.model.lm <- predict(model.6, df.test)
MSE.lm <- sum((y.model.lm - y.fact)^2) / length(y.model.lm)

# kNN требует на вход только числовые переменные
df.train.num <- as.data.frame(apply(df.train, 2, as.numeric))
df.test.num <- as.data.frame(apply(df.test, 2, as.numeric))

for (i in 2:50){
    model.knn <- knn.reg(train = df.train.num[, !(colnames(df.train.num) %in% 'salary')], 
                     y = df.train.num[, 'salary'], 
                     test = df.test.num, k = i)
    y.model.knn <- model.knn$pred
    if (i == 2){
        MSE.knn <- sum((y.model.knn - y.fact)^2) / length(y.model.knn)
    } else {
        MSE.knn <- c(MSE.knn, 
                     sum((y.model.knn - y.fact)^2) / length(y.model.knn))
    }
}

# график
par(mar = c(4.5, 4.5, 1, 1))
# ошибки kNN
plot(2:50, MSE.knn, type = 'b', col = 'darkgreen',
     xlab = 'значение k', ylab = 'MSE на тестовой выборке')
# ошибка регрессии
lines(2:50, rep(MSE.lm, 49), lwd = 2, col = grey(0.2), lty = 2)
legend('bottomright', lty = c(1, 2), pch = c(1, NA), 
       col = c('darkgreen', grey(0.2)), 
       legend = c('k ближайших соседа', 'регрессия (все факторы)'), 
       lwd = rep(2, 2))
```

```{r, include = F}
frml.to.text.01 <- paste0('$\\frac {\\sqrt{MSE_{TEST}}}{\\bar{y}_{TEST}} = ',
                          round(sqrt(MSE.lm) / mean(y.fact) * 100, 1),
                          '\\%$')
```


Как можно видеть по графику, ошибка регрессии на тестовой выборке больше, чем ошибка метода k ближайших соседей с k от 2 до 30. Далее с увеличением количества соседей точность kNN падает. Ошибка регрессионной модели на тестовой выборке очень велика и составляет `r frml.to.text.01` от среднего значения зависимой переменной. Для модели регрессии это может означать отсутствие важного объясняющего фактора. У лучшей модели kNN также низкая точность: она ошибается на `r paste0(round(sqrt(min(MSE.knn)) / mean(y.fact) * 100, 1), '%')` от среднего значения объясняющей переменной.     


## Упражнение 3   

На наборе данных из своего варианта построить модели линейной регрессии с указанными *Y* и *X*. Рассмотреть модели с категориальными предикторами, включая их взаимодействие с непрерывными объясняющеми переменными. Сгенерировать отчёт по структуре отчёта из практики. Включить в отчёт выводы по каждому из разделов (описание данных, модели, сравнение с kNN). Ответить на вопрос, пригодна ли построенная модель регрессии для прогнозирования и почему.   
Код отчёта в файле .Rmd разместить на [github.com](github.com), отчёт в формате html – на [rpubs.com](rpubs.com). Ссылки на репозиторий и отчёт на rpubs выслать на почту.   

## Варианты   

<table border="1">
<tr>
<td rowspan="2"><b>Номер варианта</b></td>
<td rowspan="2"><b>Данные</b></td>
<td rowspan="2"><b>Зависимая переменная</b></td>
<td colspan="2"><b>Объясняющие переменные</b></td>
</tr>

<tr>
<td>непрерывные</td>
<td>дискретные (факторы)</td>
</tr>

<tr>
<td>1</td>
<td><font face = "Courier New">Boston {MASS}</font></td>
<td><font face = "Courier New">crim</font></td>
<td><font face = "Courier New">zn, rm</font></td>
<td><font face = "Courier New">chas</font></td>
</tr>

<tr>
<td>2</td>
<td><font face = "Courier New">Boston {MASS}</font></td>
<td><font face = "Courier New">crim</font></td>
<td><font face = "Courier New">tax, black, indus</font></td>
<td><font face = "Courier New">chas</font></td>
</tr>

<tr>
<td>3</td>
<td><font face = "Courier New">Boston {MASS}</font></td>
<td><font face = "Courier New">crim</font></td>
<td><font face = "Courier New">indus, age</font></td>
<td><font face = "Courier New">chas</font></td>
</tr>

<tr>
<td>4</td>
<td><font face = "Courier New">Auto {ISLR}</font></td>
<td><font face = "Courier New">mpg</font></td>
<td><font face = "Courier New">weight, acceleration, year</font></td>
<td><font face = "Courier New">cylinders</font></td>
</tr>

<tr>
<td>5</td>
<td><font face = "Courier New">Auto {ISLR}</font></td>
<td><font face = "Courier New">mpg</font></td>
<td><font face = "Courier New">weight, displacement, horsepower</font></td>
<td><font face = "Courier New">cylinders</font></td>
</tr>

<tr>
<td>6</td>
<td><font face = "Courier New">Auto {ISLR}</font></td>
<td><font face = "Courier New">mpg</font></td>
<td><font face = "Courier New">weight, displacement, acceleration</font></td>
<td><font face = "Courier New">cylinders</font></td>
</tr>

<tr>
<td>7</td>
<td><font face = "Courier New">Carseats {ISLR}</font></td>
<td><font face = "Courier New">Sales</font></td>
<td><font face = "Courier New">Price, Advertising</font></td>
<td><font face = "Courier New">US, ShelveLoc</font></td>
</tr>

<tr>
<td>8</td>
<td><font face = "Courier New">Carseats {ISLR}</font></td>
<td><font face = "Courier New">Sales</font></td>
<td><font face = "Courier New">Price, Population</font></td>
<td><font face = "Courier New">Urban</font></td>
</tr>

<tr>
<td>9</td>
<td><font face = "Courier New">Carseats {ISLR}</font></td>
<td><font face = "Courier New">Sales</font></td>
<td><font face = "Courier New">Price, Advertising</font></td>
<td><font face = "Courier New">Urban</font></td>
</tr>

<tr>
<td>10</td>
<td><font face = "Courier New">College {ISLR}</font></td>
<td><font face = "Courier New">Accept</font></td>
<td><font face = "Courier New">Books, Personal, PhD</font></td>
<td><font face = "Courier New">Private</font></td>
</tr>

<tr>
<td>11</td>
<td><font face = "Courier New">College {ISLR}</font></td>
<td><font face = "Courier New">Accept</font></td>
<td><font face = "Courier New">BGrad.Rate, PhD, Expend</font></td>
<td><font face = "Courier New">Private</font></td>
</tr>

<tr>
<td>12</td>
<td><font face = "Courier New">College {ISLR}</font></td>
<td><font face = "Courier New">Accept</font></td>
<td><font face = "Courier New">Top25perc, PhD, Room.Board</font></td>
<td><font face = "Courier New">Private</font></td>
</tr>

</table>

## Как открыть данные   
На примере первого варианта: `Boston {MASS}` означает, что это набор данных `Boston` из пакета `MASS`.   

```{r, eval = F}
library(‘MASS’)         # загружаем пакет
data(Boston)            # открываем данные
?Boston                 # справка по данным
```

## Как опубликовать отчёт на RPubs

1. Зарегистрироваться на [rpubs.com](rpubs.com). Логин и пароль понадобятся при публикации отчёта.   

1. Связать отчёт (кнопка «Knit» над окном скрипта).   

1. Опубликовать отчёт (кнопка «Publish» в правом верхнем углу окна с html-документом).  

![Рис.1. Генерация отчёта](./pics/pic-01.png)

![Рис. 2. Публикация отчёта](./pics/pic-02.png)

*Источники*   

1. *James G., Witten D., Hastie T. and Tibshirani R.*  An Introduction to Statistical Learning with Applications in R. URL: [http://www-bcf.usc.edu/~gareth/ISL/ISLR%20First%20Printing.pdf](http://www-bcf.usc.edu/~gareth/ISL/ISLR%20First%20Printing.pdf)    